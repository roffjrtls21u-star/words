import React, { useState, useEffect } from 'react';
import { Play, RotateCcw, Trophy, Star, CheckCircle, XCircle, Globe, MapPin } from 'lucide-react';

// --- ë””ìì¸ ë° ìŠ¤íƒ€ì¼ ì„¤ì • (ìš”ì²­í•˜ì‹  CSS í¬í•¨) ---
const styles = `
  @import url('https://fonts.googleapis.com/css2?family=Spline+Sans:wght@400;500;600;700;800&display=swap');

  body {
    font-family: 'Spline Sans', sans-serif;
    margin: 0;
    padding: 0;
    overflow: hidden; /* ì•± ê°™ì€ ëŠë‚Œ */
  }

  .cloud-bg {
    background-color: #f7f7d4;
    background-image: 
      radial-gradient(circle at 20% 30%, white 0%, transparent 20%),
      radial-gradient(circle at 80% 15%, white 0%, transparent 15%),
      radial-gradient(circle at 50% 85%, white 0%, transparent 25%);
    background-attachment: fixed;
    background-size: cover;
  }

  .pillowy-shadow {
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.05), inset 0 -4px 0 rgba(0,0,0,0.1);
  }
  
  .pillowy-button {
    box-shadow: 0 6px 0 #e5e5e5, 0 10px 10px rgba(0,0,0,0.1);
    transition: all 0.1s;
  }
  
  .pillowy-button:active {
    transform: translateY(6px);
    box-shadow: 0 0 0 #e5e5e5, inset 0 2px 5px rgba(0,0,0,0.1);
  }

  .btn-primary {
    background-color: #ff6bc1;
    color: white;
    box-shadow: 0 6px 0 #d64598, 0 10px 10px rgba(0,0,0,0.15);
  }
  
  .btn-primary:active {
    box-shadow: 0 0 0 #d64598, inset 0 2px 5px rgba(0,0,0,0.2);
  }

  /* ì• ë‹ˆë©”ì´ì…˜ */
  @keyframes popIn {
    0% { transform: scale(0.8); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
  }
  
  .animate-pop {
    animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
  }

  @keyframes float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
    100% { transform: translateY(0px); }
  }
  .animate-float {
    animation: float 3s ease-in-out infinite;
  }
`;

// --- í€´ì¦ˆ ë°ì´í„° (Geminiê°€ ìƒì„±í•œ ë°ì´í„°ë² ì´ìŠ¤ ì—­í• ) ---
const COUNTRY_DATA = [
  { code: 'kr', name: 'ëŒ€í•œë¯¼êµ­', capital: 'ì„œìš¸', emoji: 'ğŸ‡°ğŸ‡·' },
  { code: 'us', name: 'ë¯¸êµ­', capital: 'ì›Œì‹±í„´ D.C.', emoji: 'ğŸ‡ºğŸ‡¸' },
  { code: 'jp', name: 'ì¼ë³¸', capital: 'ë„ì¿„', emoji: 'ğŸ‡¯ğŸ‡µ' },
  { code: 'cn', name: 'ì¤‘êµ­', capital: 'ë² ì´ì§•', emoji: 'ğŸ‡¨ğŸ‡³' },
  { code: 'gb', name: 'ì˜êµ­', capital: 'ëŸ°ë˜', emoji: 'ğŸ‡¬ğŸ‡§' },
  { code: 'fr', name: 'í”„ë‘ìŠ¤', capital: 'íŒŒë¦¬', emoji: 'ğŸ‡«ğŸ‡·' },
  { code: 'de', name: 'ë…ì¼', capital: 'ë² ë¥¼ë¦°', emoji: 'ğŸ‡©ğŸ‡ª' },
  { code: 'it', name: 'ì´íƒˆë¦¬ì•„', capital: 'ë¡œë§ˆ', emoji: 'ğŸ‡®ğŸ‡¹' },
  { code: 'ca', name: 'ìºë‚˜ë‹¤', capital: 'ì˜¤íƒ€ì™€', emoji: 'ğŸ‡¨ğŸ‡¦' },
  { code: 'au', name: 'í˜¸ì£¼', capital: 'ìº”ë²„ë¼', emoji: 'ğŸ‡¦ğŸ‡º' },
  { code: 'vn', name: 'ë² íŠ¸ë‚¨', capital: 'í•˜ë…¸ì´', emoji: 'ğŸ‡»ğŸ‡³' },
  { code: 'th', name: 'íƒœêµ­', capital: 'ë°©ì½•', emoji: 'ğŸ‡¹ğŸ‡­' },
  { code: 'in', name: 'ì¸ë„', capital: 'ë‰´ë¸ë¦¬', emoji: 'ğŸ‡®ğŸ‡³' },
  { code: 'br', name: 'ë¸Œë¼ì§ˆ', capital: 'ë¸Œë¼ì§ˆë¦¬ì•„', emoji: 'ğŸ‡§ğŸ‡·' },
  { code: 'es', name: 'ìŠ¤í˜ì¸', capital: 'ë§ˆë“œë¦¬ë“œ', emoji: 'ğŸ‡ªğŸ‡¸' },
  { code: 'eg', name: 'ì´ì§‘íŠ¸', capital: 'ì¹´ì´ë¡œ', emoji: 'ğŸ‡ªğŸ‡¬' },
];

// --- ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ ---
const getRandomItems = (array, count) => {
  const shuffled = [...array].sort(() => 0.5 - Math.random());
  return shuffled.slice(0, count);
};

const generateQuiz = () => {
  // 5ê°œì˜ ë¬¸ì œë¥¼ ìƒì„±
  const questions = [];
  const selectedCountries = getRandomItems(COUNTRY_DATA, 5);

  selectedCountries.forEach((country) => {
    const isFlagQuiz = Math.random() > 0.5; // 50% í™•ë¥ ë¡œ êµ­ê¸° ë˜ëŠ” ìˆ˜ë„ í€´ì¦ˆ
    
    // ì˜¤ë‹µ ë³´ê¸° ìƒì„± (í˜„ì¬ ì •ë‹µ ë‚˜ë¼ ì œì™¸í•˜ê³  3ê°œ ë¬´ì‘ìœ„ ì„ íƒ)
    const distractors = getRandomItems(
      COUNTRY_DATA.filter(c => c.code !== country.code), 
      3
    );

    if (isFlagQuiz) {
      // êµ­ê¸° í€´ì¦ˆ: êµ­ê¸°ë¥¼ ë³´ê³  ë‚˜ë¼ ì´ë¦„ ë§íˆê¸°
      questions.push({
        type: 'flag',
        questionText: 'ì´ êµ­ê¸°ëŠ” ì–´ëŠ ë‚˜ë¼ì¼ê¹Œìš”?',
        image: `https://flagcdn.com/w320/${country.code}.png`,
        correctAnswer: country.name,
        options: getRandomItems([country.name, ...distractors.map(d => d.name)], 4)
      });
    } else {
      // ìˆ˜ë„ í€´ì¦ˆ: ë‚˜ë¼ ì´ë¦„ì„ ë³´ê³  ìˆ˜ë„ ë§íˆê¸° (ìœ ì¹˜ì›ìƒì„ ìœ„í•´ êµ­ê¸° íŒíŠ¸ í¬í•¨)
      questions.push({
        type: 'capital',
        questionText: `${country.name}ì˜ ìˆ˜ë„ëŠ” ì–´ë””ì¼ê¹Œìš”?`,
        subText: `êµ­ê¸° íŒíŠ¸: ${country.emoji}`,
        correctAnswer: country.capital,
        options: getRandomItems([country.capital, ...distractors.map(d => d.capital)], 4)
      });
    }
  });

  return questions;
};

// --- ì»´í¬ë„ŒíŠ¸ ---

export default function App() {
  const [gameState, setGameState] = useState('home'); // home, quiz, result
  const [questions, setQuestions] = useState([]);
  const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [selectedAnswer, setSelectedAnswer] = useState(null);
  const [isCorrect, setIsCorrect] = useState(null); // true, false, or null
  const [feedbackMessage, setFeedbackMessage] = useState('');

  const startGame = () => {
    const newQuestions = generateQuiz();
    setQuestions(newQuestions);
    setCurrentQuestionIndex(0);
    setScore(0);
    setGameState('quiz');
    setSelectedAnswer(null);
    setIsCorrect(null);
  };

  const handleAnswerClick = (answer) => {
    if (selectedAnswer) return; // ì´ë¯¸ ì„ íƒí–ˆìœ¼ë©´ ë¬´ì‹œ

    const currentQuestion = questions[currentQuestionIndex];
    const correct = answer === currentQuestion.correctAnswer;
    
    setSelectedAnswer(answer);
    setIsCorrect(correct);

    if (correct) {
      setScore(s => s + 1);
      setFeedbackMessage('ìµœê³ ì˜ˆìš”! ğŸ‰');
    } else {
      setFeedbackMessage(`ì•„ì‰½ë„¤ìš”! ì •ë‹µì€ ${currentQuestion.correctAnswer} ì˜€ì–´ìš”.`);
    }

    // 1.5ì´ˆ í›„ ë‹¤ìŒ ë¬¸ì œë¡œ
    setTimeout(() => {
      if (currentQuestionIndex < questions.length - 1) {
        setCurrentQuestionIndex(prev => prev + 1);
        setSelectedAnswer(null);
        setIsCorrect(null);
        setFeedbackMessage('');
      } else {
        setGameState('result');
      }
    }, 2000);
  };

  return (
    <div className="min-h-screen cloud-bg flex items-center justify-center p-4">
      <style>{styles}</style>

      <div className="w-full max-w-lg">
        {/* --- í™ˆ í™”ë©´ --- */}
        {gameState === 'home' && (
          <div className="bg-white/80 backdrop-blur-sm rounded-3xl p-8 text-center pillowy-shadow animate-pop border-4 border-white">
            <div className="w-32 h-32 bg-[#ff6bc1] rounded-full mx-auto mb-6 flex items-center justify-center shadow-lg animate-float">
              <Globe size={64} color="white" strokeWidth={2.5} />
            </div>
            <h1 className="text-4xl font-black text-[#261f2e] mb-2 tracking-tight">
              ë‚˜ë¼ í€´ì¦ˆ íƒí—˜
            </h1>
            <p className="text-gray-500 mb-8 font-medium text-lg">
              êµ­ê¸°ì™€ ìˆ˜ë„ë¥¼ ì¬ë¯¸ìˆê²Œ ë°°ì›Œë´ìš”!
            </p>
            
            <button 
              onClick={startGame}
              className="w-full btn-primary py-5 rounded-2xl text-2xl font-bold flex items-center justify-center gap-3 transform transition hover:scale-105 active:scale-95"
            >
              <Play fill="currentColor" /> ê²Œì„ ì‹œì‘
            </button>
            
            <div className="mt-8 grid grid-cols-2 gap-4">
               <div className="bg-[#f7f7d4] p-4 rounded-xl text-[#261f2e] font-bold text-sm">
                 ğŸš© êµ­ê¸° ë§íˆê¸°
               </div>
               <div className="bg-[#d4f7f7] p-4 rounded-xl text-[#261f2e] font-bold text-sm">
                 ğŸ›ï¸ ìˆ˜ë„ ë§íˆê¸°
               </div>
            </div>
          </div>
        )}

        {/* --- í€´ì¦ˆ í™”ë©´ --- */}
        {gameState === 'quiz' && questions.length > 0 && (
          <div className="w-full">
            {/* ìƒë‹¨ ì§„í–‰ë°” */}
            <div className="flex justify-between items-center mb-6 px-2">
              <div className="bg-white px-4 py-2 rounded-full shadow-sm font-bold text-[#ff6bc1] flex items-center gap-2">
                <Star fill="#ff6bc1" size={18} /> 
                ì ìˆ˜: {score}
              </div>
              <div className="bg-white px-4 py-2 rounded-full shadow-sm font-bold text-gray-500">
                ë¬¸ì œ {currentQuestionIndex + 1} / {questions.length}
              </div>
            </div>

            <div className="bg-white rounded-3xl p-6 pillowy-shadow border-4 border-white relative overflow-hidden">
               {/* ì§ˆë¬¸ ì˜ì—­ */}
               <div className="text-center mb-8">
                  <span className="inline-block bg-[#f7f7d4] text-[#261f2e] px-3 py-1 rounded-full text-sm font-bold mb-4">
                    {questions[currentQuestionIndex].type === 'flag' ? 'êµ­ê¸° í€´ì¦ˆ ğŸš©' : 'ìˆ˜ë„ í€´ì¦ˆ ğŸ›ï¸'}
                  </span>
                  
                  <h2 className="text-2xl font-black text-[#261f2e] mb-4">
                    {questions[currentQuestionIndex].questionText}
                  </h2>
                  
                  {questions[currentQuestionIndex].subText && (
                    <p className="text-lg mb-4 text-gray-500">{questions[currentQuestionIndex].subText}</p>
                  )}

                  {questions[currentQuestionIndex].type === 'flag' && (
                    <div className="mx-auto w-full max-w-[280px] h-48 bg-gray-100 rounded-xl overflow-hidden shadow-inner border-4 border-gray-100 mb-4 flex items-center justify-center">
                      <img 
                        src={questions[currentQuestionIndex].image} 
                        alt="Flag" 
                        className="w-full h-full object-cover"
                      />
                    </div>
                  )}
               </div>

               {/* ë³´ê¸° ì˜ì—­ */}
               <div className="grid grid-cols-2 gap-4">
                  {questions[currentQuestionIndex].options.map((option, idx) => {
                    let btnClass = "bg-white text-gray-700 pillowy-button hover:bg-gray-50";
                    
                    if (selectedAnswer) {
                      if (option === questions[currentQuestionIndex].correctAnswer) {
                        btnClass = "bg-green-400 text-white pillowy-button ring-4 ring-green-200"; // ì •ë‹µ
                      } else if (option === selectedAnswer) {
                        btnClass = "bg-red-400 text-white pillowy-button ring-4 ring-red-200"; // ì˜¤ë‹µ ì„ íƒ
                      } else {
                        btnClass = "bg-gray-100 text-gray-400 opacity-50"; // ë‚˜ë¨¸ì§€
                      }
                    }

                    return (
                      <button
                        key={idx}
                        onClick={() => handleAnswerClick(option)}
                        disabled={!!selectedAnswer}
                        className={`
                          ${btnClass}
                          py-6 px-2 rounded-xl text-lg font-bold
                          flex items-center justify-center text-center leading-tight
                          min-h-[80px] transition-all
                        `}
                      >
                        {option}
                      </button>
                    );
                  })}
               </div>

               {/* í”¼ë“œë°± ì˜¤ë²„ë ˆì´ */}
               {selectedAnswer && (
                 <div className="absolute inset-0 bg-white/40 backdrop-blur-[2px] flex flex-col items-center justify-center animate-pop z-10 rounded-2xl">
                    <div className={`p-6 rounded-3xl shadow-2xl mb-4 ${isCorrect ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}`}>
                      {isCorrect ? <CheckCircle size={64} strokeWidth={3} /> : <XCircle size={64} strokeWidth={3} />}
                    </div>
                    <div className="bg-white px-6 py-3 rounded-xl shadow-lg font-bold text-xl text-[#261f2e]">
                      {feedbackMessage}
                    </div>
                 </div>
               )}
            </div>
          </div>
        )}

        {/* --- ê²°ê³¼ í™”ë©´ --- */}
        {gameState === 'result' && (
          <div className="bg-white/90 backdrop-blur-md rounded-3xl p-8 text-center pillowy-shadow animate-pop border-4 border-white">
            <div className="mb-6 relative inline-block">
               <Trophy size={80} className="text-yellow-400 drop-shadow-lg animate-float" fill="currentColor" />
               <Star size={30} className="text-[#ff6bc1] absolute -top-2 -right-4 animate-spin-slow" fill="currentColor" />
            </div>
            
            <h2 className="text-3xl font-black text-[#261f2e] mb-2">í€´ì¦ˆ ë!</h2>
            
            <div className="bg-[#f7f7d4] rounded-2xl p-6 my-6">
              <p className="text-gray-500 font-bold mb-2">ë‚´ ì ìˆ˜ëŠ”?</p>
              <div className="text-5xl font-black text-[#ff6bc1] tracking-tighter">
                {score} / {questions.length}
              </div>
            </div>

            <p className="text-gray-600 font-medium mb-8 text-lg">
              {score === questions.length ? "ì™€ìš°! í€´ì¦ˆ ì²œì¬ì˜ˆìš”! ğŸ†" : 
               score >= 3 ? "ì°¸ ì˜í–ˆì–´ìš”! ì¡°ê¸ˆë§Œ ë” í˜ë‚´ìš”! ğŸŒŸ" : 
               "ê´œì°®ì•„ìš”! ë‹¤ì‹œ ë„ì „í•´ë³¼ê¹Œìš”? ğŸ’ª"}
            </p>

            <button 
              onClick={startGame}
              className="w-full btn-primary py-5 rounded-2xl text-xl font-bold flex items-center justify-center gap-2 transform transition hover:scale-105 active:scale-95"
            >
              <RotateCcw /> ë‹¤ì‹œ í•˜ê¸°
            </button>
          </div>
        )}
      </div>
    </div>
  );
}